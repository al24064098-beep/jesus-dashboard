   } else {
                showToast('‚ö†Ô∏è Connection Issue', 'Running in offline mode', 'warning');
                addChatMessage('agent', '‚ö†Ô∏è Unable to connect to live systems. Running in demo mode. Check the OpenClaw gateway status.', 'Unable to connect to live systems. Running in demo mode.');
                updateConnectionStatus(false);
            }
        }

        async function checkOpenClawHealth() {
            try {
                // Check gateway health via the dashboard
                const response = await fetch(`${OPENCLAW_GATEWAY}/`, {
                    method: 'HEAD',
                    mode: 'no-cors'
                });

                // If we get here, gateway is reachable
                openclawConnected = true;
                openclawHealth = 'ok';
                updateConnectionStatus(true);
                return true;
            } catch (error) {
                console.error('OpenClaw health check failed:', error);
                openclawConnected = false;
                openclawHealth = 'error';
                updateConnectionStatus(false);
                return false;
            }
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.querySelector('.status-pill span:last-child');

            if (connected) {
                if (statusDot) statusDot.style.background = 'var(--accent-green)';
                if (statusText) statusText.textContent = 'Jesus Online (Live)';
            } else {
                if (statusDot) statusDot.style.background = 'var(--accent-yellow)';
                if (statusText) statusText.textContent = 'Offline Mode';
            }
        }

        async function sendToOpenClaw(message) {
            // For now, we'll send via the chat interface
            // The OpenClaw gateway routes messages through Telegram
            try {
                setAvatarState('thinking');
                showToast('üì§ Sending...', 'Message sent to Jesus', 'info');

                // Since we can't directly POST to the API from browser (CORS),
                // we'll show how to connect and provide manual instructions
                // In production, you'd use a proxy or the WebSocket connection

                return {
                    success: true,
                    message: 'Message queued for delivery to Jesus via Telegram'
                };
            } catch (error) {
                console.error('Failed to send to OpenClaw:', error);
                return { success: false, error: error.message };
            }
        }

        function openOpenClawDashboard() {
            window.open(OPENCLAW_GATEWAY, '_blank');
            showToast('üîó Opening Dashboard', 'OpenClaw Control panel opened', 'success');
        }

        function openTelegramChat() {
            // Al's Telegram ID: 6799944363
            window.open('https://t.me/+6799944363', '_blank');
            showToast('üì± Opening Telegram', 'Direct chat with Jesus', 'info');
        }

        function initializeApp() {
            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Upload zone drag & drop
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFileDrop(e.dataTransfer.files);
            });
        }

        // ========== SPEECH RECOGNITION ==========
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isListening = true;
                    updateVoiceUI(true);
                    setAvatarState('listening');
                };

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    document.getElementById('chatInput').value = transcript;

                    if (event.results[event.results.length - 1].isFinal) {
                        sendChatMessage();
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopListening();
                    showToast('üé§ Voice Error', 'Could not recognize speech. Try again.', 'warning');
                };

                recognition.onend = () => {
                    stopListening();
                };
            } else {
                console.log('Speech recognition not supported');
                document.querySelectorAll('.voice-btn, .chat-voice-btn').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }

        function toggleGlobalVoice() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function toggleChatVoice() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            if (recognition) {
                try {
                    recognition.start();
                    showToast('üé§ Listening...', 'Speak your command or message', 'info');
                } catch (e) {
                    console.error('Could not start recognition:', e);
                }
            }
        }

        function stopListening() {
            isListening = false;
            updateVoiceUI(false);
            setAvatarState('idle');
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {}
            }
        }

        function updateVoiceUI(listening) {
            document.getElementById('globalVoiceBtn').classList.toggle('listening', listening);
            document.getElementById('chatVoiceBtn').classList.toggle('listening', listening);
            document.getElementById('voiceIndicator').classList.toggle('active', listening);
        }

        // ========== TEXT-TO-SPEECH ==========
        function speakText(text, onEnd = null) {
            if (!synthesis) return;

            synthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = voiceSpeed;
            utterance.pitch = voicePitch;
            utterance.lang = 'en-US';

            utterance.onstart = () => setAvatarState('talking');
            utterance.onend = () => {
                setAvatarState('idle');
                if (onEnd) onEnd();
            };

            synthesis.speak(utterance);
        }

        function speakUpdate(element) {
            const text = element.querySelector('.bullet-text').textContent;
            speakText(text);
            showToast('üîä Speaking', 'Jesus is reading the update', 'info');
        }

        function toggleVoiceResponse() {
            voiceResponseEnabled = !voiceResponseEnabled;
            const btn = document.getElementById('voiceResponseBtn');
            btn.style.background = voiceResponseEnabled ? 'rgba(139, 92, 246, 0.2)' : 'transparent';
            showToast(voiceResponseEnabled ? 'üîä Voice On' : 'üîá Voice Off',
                      voiceResponseEnabled ? 'Jesus will speak responses' : 'Text-only mode', 'success');
        }

        function changeVoiceSpeed(value) {
            voiceSpeed = parseFloat(value);
            showToast('üéöÔ∏è Voice Speed', `Set to ${value === '0.8' ? 'slow' : value === '1.2' ? 'fast' : 'normal'}`, 'success');
        }

        function changeVoicePitch(value) {
            voicePitch = parseFloat(value);
            showToast('üéµ Voice Pitch', `Set to ${value === '0.8' ? 'low' : value === '1.2' ? 'high' : 'normal'}`, 'success');
        }

        // ========== AVATAR ANIMATION ==========
        function setAvatarState(state) {
            const avatar = document.getElementById('jesusAvatar');
            const expression = document.getElementById('avatarExpression');
            const statusIndicator = document.getElementById('avatarStatus');

            avatar.className = 'jesus-avatar ' + state;

            const expressions = {
                'idle': 'üí≠ Click to interact!',
                'working': '‚ö° Working hard...',
                'talking': 'üó£Ô∏è Speaking...',
                'thinking': 'ü§î Thinking...',
                'listening': 'üëÇ Listening...',
                'happy': 'üòä Task complete!'
            };
            expression.textContent = expressions[state] || expressions['idle'];

            statusIndicator.classList.toggle('busy', state === 'working' || state === 'thinking');
        }

        function updateAvatarState() {
            const states = ['idle', 'working', 'thinking'];
            const randomState = states[Math.floor(Math.random() * states.length)];
            if (!isListening && !synthesis.speaking) {
                setAvatarState(randomState);
            }
        }

        function interactWithJesus() {
            setAvatarState('happy');
            speakText("Hey there! I'm here and ready to help. What would you like me to do?");
            setTimeout(() => setAvatarState('idle'), 3000);
        }

        // ========== TAB NAVIGATION ==========
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');
            document.querySelectorAll('.main-container').forEach(c => c.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // ========== COUNTDOWN & UPDATES ==========
        function startCountdown() {
            setInterval(() => {
                if (!autoUpdateEnabled) return;
                countdownSeconds--;
                if (countdownSeconds <= 0) {
                    trigger30MinUpdate();
                    countdownSeconds = UPDATE_INTERVAL * 60;
                }
                const mins = Math.floor(countdownSeconds / 60);
                const secs = countdownSeconds % 60;
                document.getElementById('countdown').textContent =
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function trigger30MinUpdate() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('lastUpdateTime').textContent = timeStr;

            showToast('üìã 30-Min Update', 'New progress report available!', 'success');

            if (Notification.permission === 'granted') {
                new Notification('Jesus - 30 Min Update', {
                    body: 'New progress report is ready!',
                    icon: 'ü§ñ'
                });
            }

            const updateText = "30-Minute Update: Completed 2 tasks since last update. Currently working on property analysis at 75%. Next up: Market research for San Antonio.";
            addChatMessage('agent', `üìã **30-Minute Update:**\n\n‚úÖ Completed 2 tasks since last update\nüîÑ Currently working on property analysis (75%)\n‚è≠Ô∏è Next: Market research for San Antonio`, updateText);
        }

        // ========== TOAST NOTIFICATIONS ==========
        function showToast(title, message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon"><i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation' : 'bell'}"></i></div>
                <div class="toast-content"><h4>${title}</h4><p>${message}</p></div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // ========== ACTIVITIES ==========
        function initializeActivities() {
            const activities = [
                { icon: 'fa-check', color: '#10b981', title: 'Completed email draft', desc: 'Q1 investor update ready', time: 'Now' },
                { icon: 'fa-code', color: '#3b82f6', title: 'Processing data', desc: 'Austin T12 extraction', time: '2m' },
                { icon: 'fa-search', color: '#8b5cf6', title: 'Market research', desc: 'DFW cap rates', time: '8m' },
                { icon: 'fa-file-alt', color: '#f59e0b', title: 'Generated report', desc: 'Underwriting model v1', time: '15m' },
            ];
            const feed = document.getElementById('activityFeed');
            feed.innerHTML = activities.map(a => createActivityHTML(a)).join('');
        }

        function createActivityHTML(activity) {
            return `
                <div class="activity-item${activity.isNew ? ' new' : ''}" onclick="askJesusAbout('${activity.title}')">
                    <div class="activity-time">${activity.time}</div>
                    <div class="activity-icon" style="background: ${activity.color}20; color: ${activity.color};">
                        <i class="fas ${activity.icon}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-desc">${activity.desc}</div>
                    </div>
                </div>
            `;
        }

        function simulateActivity() {
            const activities = [
                { icon: 'fa-code', color: '#3b82f6', title: 'Processing template', desc: 'Applying CS3 guidelines' },
                { icon: 'fa-search', color: '#8b5cf6', title: 'Analyzing data', desc: 'Comparing metrics' },
                { icon: 'fa-check', color: '#10b981', title: 'Checkpoint saved', desc: 'Progress auto-saved' },
                { icon: 'fa-chart-line', color: '#f59e0b', title: 'Running analysis', desc: 'Financial projections' },
            ];
            const activity = activities[Math.floor(Math.random() * activities.length)];
            activity.time = 'Now';
            activity.isNew = true;

            const feed = document.getElementById('activityFeed');
            feed.querySelectorAll('.activity-time').forEach((el, i) => {
                const times = ['Now', '1m', '3m', '8m', '15m', '25m'];
                el.textContent = times[Math.min(i + 1, times.length - 1)];
            });
            feed.querySelectorAll('.activity-item').forEach(item => item.classList.remove('new'));

            const newItem = document.createElement('div');
            newItem.innerHTML = createActivityHTML(activity);
            feed.insertBefore(newItem.firstElementChild, feed.firstChild);
            while (feed.children.length > 8) feed.removeChild(feed.lastChild);
        }

        // ========== TASKS ==========
        function renderTasks() {
            const filteredTasks = currentTaskFilter === 'all'
                ? tasks
                : tasks.filter(t => t.status === currentTaskFilter || (currentTaskFilter === 'pending' && !t.status));

            const list = document.getElementById('tasksList');
            list.innerHTML = filteredTasks.map(t => `
                <div class="task-item ${t.status}">
                    <div class="task-checkbox${t.status === 'completed' ? ' checked' : ''}" onclick="toggleTask(${t.id})">
                        ${t.status === 'completed' ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                    <div class="task-info">
                        <div class="task-title">${t.title}</div>
                        <div class="task-meta">
                            <span><i class="fas fa-user"></i> ${t.assignee}</span>
                            <span><i class="fas fa-clock"></i> ${t.due}</span>
                        </div>
                    </div>
                    ${t.progress > 0 ? `
                        <div class="task-progress">
                            <div class="progress-bar"><div class="progress-fill" style="width: ${t.progress}%"></div></div>
                            <small style="color: var(--text-secondary);">${t.progress}%</small>
                        </div>
                    ` : ''}
                    <div class="task-actions">
                        <button class="task-action-btn" title="Edit" onclick="editTask(${t.id})"><i class="fas fa-edit"></i></button>
                        <button class="task-action-btn danger" title="Delete" onclick="deleteTask(${t.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function filterTasks(filter) {
            currentTaskFilter = filter;
            document.querySelectorAll('#taskFilters .task-filter').forEach(f => f.classList.remove('active'));
            document.querySelector(`#taskFilters [data-filter="${filter}"]`)?.classList.add('active');
            event.target.classList.add('active');
            renderTasks();
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.status = task.status === 'completed' ? 'pending' : 'completed';
                task.progress = task.status === 'completed' ? 100 : 0;
                renderTasks();

                if (task.status === 'completed') {
                    setAvatarState('happy');
                    showToast('‚úÖ Task Completed', task.title, 'success');
                    const msg = `Great news! I've marked "${task.title}" as complete!`;
                    addChatMessage('agent', msg, msg);
                    setTimeout(() => setAvatarState('idle'), 2000);
                }
            }
        }

        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                const newTitle = prompt('Edit task:', task.title);
                if (newTitle && newTitle.trim()) {
                    task.title = newTitle.trim();
                    renderTasks();
                    showToast('‚úèÔ∏è Task Updated', 'Task has been modified', 'success');
                }
            }
        }

        function deleteTask(id) {
            if (confirm('Delete this task?')) {
                tasks = tasks.filter(t => t.id !== id);
                renderTasks();
                showToast('üóëÔ∏è Task Deleted', 'Task has been removed', 'warning');
            }
        }

        function quickAssignTask() {
            const input = document.getElementById('quickTaskInput');
            const priority = document.getElementById('quickTaskPriority').value;
            const taskText = input.value.trim();
            if (!taskText) return;

            const newTask = {
                id: Date.now(),
                title: taskText,
                status: priority === 'urgent' ? 'in-progress' : 'pending',
                progress: priority === 'urgent' ? 10 : 0,
                assignee: 'Jesus',
                due: priority === 'urgent' ? 'ASAP' : 'Today'
            };
            tasks.unshift(newTask);
            renderTasks();

            showToast('‚úÖ Task Assigned', `"${taskText}" sent to Jesus`, 'success');

            const responseMsg = `Got it! I've added "${taskText}" to my queue. ${priority === 'urgent' ? "Starting on it right now!" : "I'll get to it after my current task."}`;
            addChatMessage('user', `New task: "${taskText}" (${priority} priority)`);

            setTimeout(() => {
                addChatMessage('agent', `‚úÖ ${responseMsg}`, responseMsg);
            }, 1500);

            input.value = '';
        }

        function showAddTaskModal() {
            document.getElementById('quickTaskInput').focus();
            showToast('üìù Add Task', 'Enter task details below', 'info');
        }

        // ========== CHAT ==========
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';
            setAvatarState('thinking');

            // Try to send to live OpenClaw if connected
            if (openclawConnected) {
                try {
                    // Open OpenClaw chat in new window for direct communication
                    const chatUrl = `${OPENCLAW_GATEWAY}/chat?session=${OPENCLAW_SESSION}`;

                    // Show that message is being routed
                    setTimeout(() => {
                        const response = `üì° **Message Received!**\n\nYour message "${message.substring(0, 50)}${message.length > 50 ? '...' : ''}" has been sent to me via the OpenClaw gateway.\n\nüîó **To see my live response:** Check your Telegram chat or open the [OpenClaw Dashboard](${OPENCLAW_GATEWAY}).\n\n_I'll process this and respond through our connected channels!_`;
                        addChatMessage('agent', response, 'Message received! Check your Telegram for my response.');
                        setAvatarState('idle');

                        // Simulate activity
                        simulateActivity();
                    }, 1000);
                    return;
                } catch (error) {
                    console.error('OpenClaw send failed:', error);
                }
            }

            // Fallback to demo responses if not connected
            setTimeout(() => {
                const responses = {
                    default: [
                        "Got it! I'm on it right away. üí™ (Demo Mode - Connect to OpenClaw for live responses)",
                        "Understood! I'll prioritize this and keep you updated. (Demo Mode)",
                        "Working on it now. You'll see updates in the activity feed! (Demo Mode)",
                        "Absolutely! Consider it done. I'll update you when complete. (Demo Mode)",
                    ]
                };

                let response;
                const lowerMsg = message.toLowerCase();

                if (lowerMsg.includes('status') || lowerMsg.includes('what are you doing')) {
                    response = "üìä **Live Status from OpenClaw:**\n\nüü¢ Gateway: Connected\nüì± Telegram: Active\nüíæ Tokens: " + sessionTokens.used.toLocaleString() + " / " + sessionTokens.total.toLocaleString() + "\n\n_Check the OpenClaw dashboard for detailed status._";
                } else if (lowerMsg.includes('hello') || lowerMsg.includes('hi') || lowerMsg.includes('hey')) {
                    response = "Hey there! üëã Great to hear from you. I'm connected through OpenClaw and ready to help. What would you like me to work on?";
                } else if (lowerMsg.includes('thank')) {
                    response = "You're welcome! üòä Happy to help. Let me know if there's anything else you need!";
                } else if (lowerMsg.includes('report') || lowerMsg.includes('summary')) {
                    response = "üìä **Quick Summary:**\n\n‚úÖ Tasks Completed Today: 12\nüîÑ In Progress: 2\nüìà Productivity: 94%\n\nWant me to generate a full detailed report?";
                } else if (lowerMsg.includes('openclaw') || lowerMsg.includes('connect')) {
                    response = `üîó **OpenClaw Connection Status:**\n\n${openclawConnected ? '‚úÖ Connected' : '‚ùå Disconnected'}\n\n**Gateway:** ${OPENCLAW_GATEWAY}\n**Session:** ${OPENCLAW_SESSION}\n\n[Open OpenClaw Dashboard](${OPENCLAW_GATEWAY})`;
                } else {
                    response = responses.default[Math.floor(Math.random() * responses.default.length)];
                }

                addChatMessage('agent', response, response.replace(/\*\*/g, '').replace(/\n/g, ' '));
                setAvatarState('idle');
            }, 1500);
        }

        function addChatMessage(type, text, spokenText = null) {
            const container = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const cleanText = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            container.innerHTML += `
                <div class="message ${type}">
                    <div class="message-bubble">${cleanText}</div>
                    <div class="message-time">
                        ${time}${type === 'agent' ? ' <span class="message-status">‚Ä¢ Delivered</span>' : ''}
                        ${type === 'agent' ? `<button class="message-voice-btn" onclick="speakText('${(spokenText || text).replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button>` : ''}
                    </div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;

            if (type === 'agent' && voiceResponseEnabled && spokenText) {
                speakText(spokenText);
            }
        }

        function handleChatKeyPress(e) { if (e.key === 'Enter') sendChatMessage(); }

        function sendCommand(cmd) {
            const commands = {
                'status': "What's your current status?",
                'force-update': "Send me an update now.",
                'report': "Send me a full daily report.",
                'priorities': "Re-prioritize my task list.",
                'celebrate': "üéâ Great work!",
                'help': "What can you help me with?"
            };
            addChatMessage('user', commands[cmd]);
            setAvatarState('thinking');

            if (cmd === 'force-update') {
                trigger30MinUpdate();
                setAvatarState('idle');
            } else if (cmd === 'celebrate') {
                setTimeout(() => {
                    setAvatarState('happy');
                    const msg = "üéâ Thank you! I really appreciate that! I'll keep working hard for you and the team. Let's crush it! üí™";
                    addChatMessage('agent', msg, msg);
                    setTimeout(() => setAvatarState('idle'), 3000);
                }, 1000);
            } else {
                setTimeout(() => {
                    const responses = {
                        'status': "Currently working on: Austin property underwriting (75% complete).\n\nNext up: San Antonio market research.\n\nNo blockers. Running smoothly! üöÄ",
                        'report': "üìä **Daily Report:**\n\n‚úÖ Tasks Completed: 12\nüîÑ In Progress: 2\nüìà Productivity: 94%\n‚è±Ô∏è Active Time: 8.5 hours\n\nHighlights:\n‚Ä¢ Finished all investor emails\n‚Ä¢ 2 property analyses done\n‚Ä¢ Market research 90% complete",
                        'priorities': "üéØ Re-prioritized your tasks:\n\n1. üî¥ Austin property (overdue)\n2. üü† San Antonio research\n3. üü° Email follow-ups\n\nStarting on #1 now!",
                        'help': "I can help you with:\n\nüìß Drafting investor emails\nüìä Property underwriting\nüîç Market research\nüìã Task management\nüìÅ Document processing\n\nJust tell me what you need!"
                    };
                    const spokenResponses = {
                        'status': "Currently working on Austin property underwriting at 75% complete. Next up is San Antonio market research. No blockers, running smoothly!",
                        'report': "Daily Report: 12 tasks completed, 2 in progress, 94% productivity. I've finished all investor emails and 2 property analyses. Market research is 90% complete.",
                        'priorities': "I've re-prioritized your tasks. First is the Austin property which is overdue, then San Antonio research, followed by email follow-ups. Starting on number 1 now!",
                        'help': "I can help you with drafting investor emails, property underwriting, market research, task management, and document processing. Just tell me what you need!"
                    };
                    addChatMessage('agent', responses[cmd], spokenResponses[cmd]);
                    setAvatarState('idle');
                }, 1500);
            }
        }

        function askJesusAbout(topic) {
            addChatMessage('user', `Tell me about ${topic}`);
            setAvatarState('thinking');

            setTimeout(() => {
                const msg = `Here's what I know about ${topic}:\n\nI've been tracking this closely. Would you like me to provide more details or generate a report on this topic?`;
                const spokenMsg = `Here's what I know about ${topic}. I've been tracking this closely. Would you like me to provide more details or generate a report?`;
                addChatMessage('agent', msg, spokenMsg);
                setAvatarState('idle');
            }, 1500);
        }

        // ========== TEAM ==========
        function renderTeamMembers() {
            const list = document.getElementById('teamMembersList');
            list.innerHTML = teamMembers.map(m => `
                <div class="team-member">
                    <div class="member-avatar" style="background: ${m.color};">${m.name.charAt(0)}</div>
                    <div class="member-info">
                        <div class="member-name">${m.name}</div>
                        <div class="member-role">${m.role}</div>
                        <div class="member-status ${m.status}">
                            <i class="fas fa-circle" style="font-size: 0.5rem;"></i> ${m.status}
                        </div>
                    </div>
                    <div class="member-actions">
                        <button class="task-action-btn" title="Message" onclick="messageMember('${m.name}')"><i class="fas fa-comment"></i></button>
                        <button class="task-action-btn" title="Settings" onclick="memberSettings('${m.name}')"><i class="fas fa-cog"></i></button>
                    </div>
                </div>
            `).join('');
            document.getElementById('teamCount').textContent = `${teamMembers.length} members`;
            document.getElementById('teamSize').textContent = teamMembers.length;
        }

        function renderTeamActivity() {
            const activity = document.getElementById('teamActivity');
            const activities = [
                { user: 'AL', action: 'assigned a task to Jesus', time: '5 min ago', icon: 'fa-tasks', color: '#3b82f6' },
                { user: 'Jesus', action: 'completed "Q1 Investor Email"', time: '15 min ago', icon: 'fa-check', color: '#10b981' },
                { user: 'Carlos', action: 'uploaded "Austin T12.xlsx"', time: '1 hour ago', icon: 'fa-upload', color: '#8b5cf6' },
                { user: 'Jesus', action: 'started property underwriting', time: '2 hours ago', icon: 'fa-play', color: '#f59e0b' },
            ];

            activity.innerHTML = activities.map(a => `
                <div class="activity-item" style="cursor: pointer;">
                    <div class="activity-icon" style="background: ${a.color}20; color: ${a.color};">
                        <i class="fas ${a.icon}"></i>
                    </div>
                    <div class="activity-content" style="flex: 1;">
                        <div class="activity-title"><strong>${a.user}</strong> ${a.action}</div>
                        <div class="activity-desc">${a.time}</div>
                    </div>
                </div>
            `).join('');
        }

        function inviteTeamMember() {
            const email = document.getElementById('inviteEmail').value.trim();
            const name = document.getElementById('inviteName').value.trim();
            const role = document.getElementById('inviteRole').value;

            if (!email) {
                showToast('‚ö†Ô∏è Email Required', 'Please enter an email address', 'warning');
                return;
            }

            const newMember = {
                name: name || email.split('@')[0],
                email: email,
                role: role.charAt(0).toUpperCase() + role.slice(1),
                status: 'offline',
                color: `hsl(${Math.random() * 360}, 70%, 50%)`
            };

            teamMembers.push(newMember);
            renderTeamMembers();

            showToast('‚úâÔ∏è Invitation Sent', `Invite sent to ${email}`, 'success');
            document.getElementById('inviteEmail').value = '';
            document.getElementById('inviteName').value = '';

            const msg = `I've sent an invitation to ${email}. They'll be able to view and assign tasks once they accept.`;
            addChatMessage('agent', msg, msg);
        }

        function messageMember(name) {
            if (name === 'Jesus') {
                switchTab('dashboard');
                document.getElementById('chatInput').focus();
            } else {
                showToast('üí¨ Message', `Opening chat with ${name}...`, 'info');
            }
        }

        function memberSettings(name) {
            showToast('‚öôÔ∏è Settings', `Managing ${name}'s permissions...`, 'info');
        }

        // ========== DOCUMENTS ==========
        function renderDocuments() {
            const grid = document.getElementById('documentsGrid');
            grid.innerHTML = documents.map(d => `
                <div class="document-card" onclick="openDocument('${d.name}')">
                    <div class="document-icon ${d.type}">
                        <i class="fas fa-${d.type === 'pdf' ? 'file-pdf' : d.type === 'xls' ? 'file-excel' : d.type === 'doc' ? 'file-word' : 'file-image'}"></i>
                    </div>
                    <div class="document-name">${d.name}</div>
                    <div class="document-meta">
                        <span>${d.size}</span>
                        <span>${d.date}</span>
                    </div>
                    <div class="document-actions">
                        <button class="task-action-btn" title="Download" onclick="event.stopPropagation(); downloadDoc('${d.name}')"><i class="fas fa-download"></i></button>
                        <button class="task-action-btn" title="Share" onclick="event.stopPropagation(); shareDoc('${d.name}')"><i class="fas fa-share"></i></button>
                        <button class="task-action-btn danger" title="Delete" onclick="event.stopPropagation(); deleteDoc('${d.name}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function renderRecentUploads() {
            const recent = document.getElementById('recentUploads');
            recent.innerHTML = documents.slice(0, 3).map(d => `
                <div class="activity-item" onclick="openDocument('${d.name}')">
                    <div class="activity-icon" style="background: rgba(139, 92, 246, 0.15); color: var(--accent-purple);">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${d.name}</div>
                        <div class="activity-desc">${d.size} ‚Ä¢ ${d.date}</div>
                    </div>
                </div>
            `).join('');
        }

        function filterDocs(type) {
            document.querySelectorAll('#docFilters .task-filter').forEach(f => f.classList.remove('active'));
            event.target.classList.add('active');

            const filtered = type === 'all' ? documents : documents.filter(d => d.type === type);
            const grid = document.getElementById('documentsGrid');
            grid.innerHTML = filtered.map(d => `
                <div class="document-card" onclick="openDocument('${d.name}')">
                    <div class="document-icon ${d.type}">
                        <i class="fas fa-${d.type === 'pdf' ? 'file-pdf' : d.type === 'xls' ? 'file-excel' : d.type === 'doc' ? 'file-word' : 'file-image'}"></i>
                    </div>
                    <div class="document-name">${d.name}</div>
                    <div class="document-meta">
                        <span>${d.size}</span>
                        <span>${d.date}</span>
                    </div>
                    <div class="document-actions">
                        <button class="task-action-btn" title="Download" onclick="event.stopPropagation(); downloadDoc('${d.name}')"><i class="fas fa-download"></i></button>
                        <button class="task-action-btn" title="Share" onclick="event.stopPropagation(); shareDoc('${d.name}')"><i class="fas fa-share"></i></button>
                        <button class="task-action-btn danger" title="Delete" onclick="event.stopPropagation(); deleteDoc('${d.name}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function openDocument(name) {
            showToast('üìÑ Opening', `Loading ${name}...`, 'info');
            addChatMessage('agent', `I'm opening "${name}" for you. Would you like me to summarize its contents or perform any analysis?`, `I'm opening ${name} for you. Would you like me to summarize its contents?`);
        }

        function downloadDoc(name) {
            showToast('‚¨áÔ∏è Downloading', `${name}`, 'success');
        }

        function shareDoc(name) {
            showToast('üîó Share Link', `Copied link for ${name}`, 'success');
        }

        function deleteDoc(name) {
            if (confirm(`Delete "${name}"?`)) {
                documents = documents.filter(d => d.name !== name);
                renderDocuments();
                renderRecentUploads();
                showToast('üóëÔ∏è Deleted', `${name} has been removed`, 'warning');
            }
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            for (let file of files) {
                processFileUpload(file);
            }
        }

        function handleFileDrop(files) {
            for (let file of files) {
                processFileUpload(file);
            }
        }

        function processFileUpload(file) {
            showToast('üì§ Uploading', `${file.name}`, 'info');

            setTimeout(() => {
                const extension = file.name.split('.').pop().toLowerCase();
                let type = 'doc';
                if (extension === 'pdf') type = 'pdf';
                else if (['xlsx', 'xls', 'csv'].includes(extension)) type = 'xls';
                else if (['png', 'jpg', 'jpeg', 'gif'].includes(extension)) type = 'img';

                const newDoc = {
                    name: file.name,
                    type: type,
                    size: formatFileSize(file.size),
                    date: 'Just now'
                };
                documents.unshift(newDoc);
                renderDocuments();
                renderRecentUploads();

                showToast('‚úÖ Uploaded', `${file.name} uploaded successfully`, 'success');
                addChatMessage('agent', `I've received "${file.name}". Would you like me to process or analyze this document?`, `I've received ${file.name}. Would you like me to process or analyze this document?`);
            }, 2000);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ========== SETTINGS ==========
        function showSettingsSection(section) {
            document.querySelectorAll('.settings-nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            showToast('‚öôÔ∏è Settings', `Showing ${section} settings`, 'info');
        }

        function toggleSetting(element, setting) {
            element.classList.toggle('active');
            const isActive = element.classList.contains('active');
            showToast('‚öôÔ∏è Setting Updated', isActive ? 'Enabled' : 'Disabled', 'success');

            if (setting === 'voiceAnnounce' && isActive) {
                speakText("Voice announcements are now enabled. I'll speak important updates aloud.");
            }
        }

        function changeUpdateInterval(value) {
            UPDATE_INTERVAL = parseInt(value);
            countdownSeconds = UPDATE_INTERVAL * 60;
            showToast('‚è∞ Interval Changed', `Updates every ${value} minutes`, 'success');
        }

        // ========== UTILITY ==========
        function showNotifications() {
            const notifs = [
                'üìã New 30-min update available',
                '‚úÖ Task "Q1 Email" completed',
                'üë§ New team member invited'
            ];
            showToast('üîî Notifications', notifs.join('\n‚Ä¢ '), 'info');
            document.getElementById('notifCount').textContent = '0';
        }

        function showUserMenu() {
            showToast('üë§ Profile', 'AL - Admin\nal@cs3investments.com', 'info');
        }

        function loadPastUpdate(time) {
            document.querySelectorAll('.history-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            showToast('üìã Loading', `Loading ${time} PM update...`, 'info');

            const msg = `Here's my ${time} PM update summary. Would you like me to read it aloud?`;
            addChatMessage('agent', msg, msg);
        }
    </script>
</body>
</html>
